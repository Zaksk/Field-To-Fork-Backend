const db = require('../db/connect');

class Product {
  constructor({
    product_id,
    user_id,
    type_id,
    variety,
    description,
    created_at,
    active,
    image_url,
    price,
  }) {
    this.product_id = product_id;
    this.user_id = user_id;
    this.type_id = type_id;
    this.variety = variety;
    this.description = description;
    this.created_at = created_at;
    this.active = active;
    this.image_url = image_url;
    this.price = price;
  }

  static async getOneById(id) {
    const response = await db.query(
      "SELECT * FROM products WHERE product_id = $1",
      [id]
    );

    if (response.rows.length !== 1) {
      throw new Error("Product not found.");
    }
    return new Product(response.rows[0]);
  }

  static async create(data) {
    const { user_id, type_id, variety, description, active, image_url, price } = data;

    if (user_id === undefined || type_id === undefined || active === undefined) {
      throw new Error("Ensure the product type, user_id and active status are provided");
    }

    let response = await db.query(
      "INSERT INTO products (user_id, type_id, variety, description, active, image_url, price) VALUES ($1, $2, $3, $4, $5, $6, $7) RETURNING *",
      [user_id, type_id, variety, description, active, image_url, price]
    );

    const newId = response.rows[0].product_id;
    const newProduct = await Product.getOneById(newId);
    return newProduct;
  }

  static async getAll(user_id) {
    const id = user_id;
    const response = await db.query("SELECT * FROM products WHERE user_id = $1 ORDER BY created_at DESC", [id]);
    if (response.rows.length == 0) {
        throw new Error("No products found");
    } else {
        return response.rows.map((el) => new Product(el));
    }
  }

async  update(data) {
    const {type_id, variety, description, active, image_url, price} = data
    let response = await db.query("UPDATE products SET type_id = $1, variety = $2, description = $3, active = $4, image_url = $5, price = $6 WHERE product_id = $7 RETURNING *", [type_id, variety, description, active, image_url, price, this.product_id])
    if (response.rows.length !== 1) {
      throw Error('Could not update the product!');
    } else {
      return response.rows[0];
    }
  }

/* TO DO
  async filterByCategory(category_id) {
    let responce = await db.query("SELECT * from products WHERE ")

} */
}
module.exports = Product;